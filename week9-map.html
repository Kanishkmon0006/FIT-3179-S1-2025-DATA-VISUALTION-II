<script>
  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": 800,
    "height": 500,
    "title": "Percentage of Overseas-Born Residents by SA2 Region",
    "data": {
      "url": "data/australia_sa2.json",
      "format": {"type": "topojson", "feature": "SA2_2021_AUST"}
    },
    "transform": [
      {
        "lookup": "properties.SA2_CODE21",
        "from": {
          "data": {"url": "data/migration_data.csv"},
          "key": "SA2_CODE",
          "fields": ["overseas_percent"]
        }
      },
      {"filter": "datum.overseas_percent != null"}
    ],
    "projection": {"type": "equirectangular"},
    "mark": "geoshape",
    "encoding": {
      "color": {
        "field": "overseas_percent",
        "type": "quantitative",
        "scale": {"scheme": "blues", "domain": [0, 100]},
        "title": "% Overseas Born"
      },
      "tooltip": [
        {"field": "properties.SA2_NAME21", "type": "nominal", "title": "Region"},
        {"field": "overseas_percent", "type": "quantitative", "title": "Overseas Born %", "format": ".1f"}
      ]
    },
    "config": {"view": {"stroke": null}}
  };
  
  vegaEmbed('#vis', spec)
    .then(result => console.log("Visualization loaded successfully"))
    .catch(error => {
      console.error("Error loading visualization:", error);
      // Display error message to user
      document.getElementById('vis').innerHTML = 
        '<div style="color: red; text-align: center; padding: 20px;">' +
        'Error loading map. Check console for details and ensure data files are available.' +
        '</div>';
    });
</script>